---
title: "Spring Boot + Thymeleafã§CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹"
emoji: "ğŸ“"
type: "tech"
topics:
  - "kotlin"
  - "csv"
  - "springboot"
published: false
published_at: "2024-04-19 15:11"
---

# ã¯ã˜ã‚ã«
æ§˜ã€…ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®ä»•çµ„ã¿ã€‚
ã¿ãªã•ã‚“ã¯å®Ÿè£…ã—ãŸã“ã¨ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
ä»Šå›ã¯CSVãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®å®Ÿè£…ã‚’ã—ã¦ã¿ã¾ã—ãŸã€‚

## ä½¿ç”¨æŠ€è¡“
- Spring Boot
- Thymeleaf
- [jackson-dataformat-csv](https://mvnrepository.com/artifact/com.fasterxml.jackson.dataformat/jackson-dataformat-csv)

:::message
è¨€èªã¯Kotlinã§æ›¸ã„ã¦ã¾ã™
:::

## Jackson
Jacksonã¯Javaã§JSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
CSV,Properties,TOML,YAMLãªã©ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†ãŸã‚ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚‚å­˜åœ¨ã—ã¦ã„ã¦ã€ä»Šå›ã¯CSVã‚’ä½¿ç”¨ã™ã‚‹ã®ã§ã€[jackson-dataformat-csv](https://mvnrepository.com/artifact/com.fasterxml.jackson.dataformat/jackson-dataformat-csv)ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

## è¦ä»¶
Thymeleafã§ä½œã£ãŸãƒªãƒ³ã‚¯ã‚’æŠ¼ä¸‹ã™ã‚‹ã¨CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã€‚

## å®Ÿè£…
### ç”»é¢è¡¨ç¤º
ã¾ãšã¯Controllerã¨ç”»é¢ã‚’ä½œã£ã¦è¡¨ç¤ºã•ã›ã¦ã„ããƒ¼ã€‚
```kotlin:FileDownLoadController
package com.example.demo.controller

import org.springframework.stereotype.Controller
import org.springframework.web.bind.annotation.GetMapping
import org.springframework.web.bind.annotation.RequestMapping

@Controller
@RequestMapping("/download")
class FileDownLoadController() {
    @GetMapping
    fun index(): String {
        return "/index"
    }
}
```
```html:index.html
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</title>
  </head>
  <body>
    <a th:href="@{/download/csv}">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
  </body>
</html>
```
ã“ã‚“ãªç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚
![](https://storage.googleapis.com/zenn-user-upload/3ed1b6f2e43e-20240419.png)


### ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
ç”»é¢ãŒã§ããŸã®ã§ã€ã“ã“ã‹ã‚‰CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡ºæ¥ã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã¾ã™ã€‚
ä»Šå›ã¯ç”Ÿå¾’ã®ãƒ‡ãƒ¼ã‚¿ã‚’CSVã«å‡ºåŠ›ã—ã¾ã™ã€‚
```kotlin:StudentDto
package com.example.demo.dto

data class StudentDto(
    val id: String,
    val name: String,
    val department: String,
)
```
Controllerã®downloadCsvã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚
```kotlin:FileDownLoadController
package com.example.demo.controller

import com.example.demo.dto.StudentDto
import com.fasterxml.jackson.dataformat.csv.CsvMapper
import jakarta.servlet.http.HttpServletResponse
import org.springframework.http.HttpHeaders
import org.springframework.http.MediaType
import org.springframework.http.ResponseEntity
import org.springframework.stereotype.Controller
import org.springframework.web.bind.annotation.GetMapping
import org.springframework.web.bind.annotation.RequestMapping

@Controller
@RequestMapping("/download")
class FileDownLoadController() {
    companion object {
        private val MEDIA_TYPE_TEXT_CSV = MediaType("text", "csv")
        private const val CONTENT_DISPOSITION_HEADER = "attachment; filename=test.csv; filename*=UTF-8"
    }

    @GetMapping
    fun index(): String {
        return "/index"
    }

    @GetMapping("/csv")
    fun downloadCsv(): ResponseEntity<ByteArray> {
        // ç”Ÿå¾’ã®ä»®ãƒ‡ãƒ¼ã‚¿
        val studentList =
            listOf(
                StudentDto("a20019", "ãƒ†ã‚¹ãƒˆ1", "TB"),
                StudentDto("b20008", "ãƒ†ã‚¹ãƒˆ2", "UT"),
                StudentDto("c20198", "ãƒ†ã‚¹ãƒˆ3", "CT")
            )
        val csvMapper = CsvMapper()
        val schema = csvMapper.schemaFor(StudentDto::class.java).withHeader()
        val studentText = csvMapper.writer(schema).writeValueAsString(studentList)
        val csvBytes = studentText.toByteArray(Charsets.UTF_8)

        return ResponseEntity.ok()
            .header(HttpHeaders.CONTENT_DISPOSITION, CONTENT_DISPOSITION_HEADER)
            .contentType(MEDIA_TYPE_TEXT_CSV)
            .body(csvBytes)
    }
}
```

## ã–ã£ãã‚Šè§£èª¬
ã¾ãšã€CsvMapperã§è‰¯ã„æ„Ÿã˜ã«ã‚´ãƒ‹ãƒ§ã‚´ãƒ‹ãƒ§ã—ã¤ã¤ã€ç”Ÿå¾’ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚¤ãƒˆé…åˆ—ã«å¤‰æ›ã—ã¦ã„ã¾ã™ã€‚
```kotlin
// ç”Ÿå¾’ã®ä»®ãƒ‡ãƒ¼ã‚¿
val studentList =
    listOf(
        StudentDto("a20019", "ãƒ†ã‚¹ãƒˆ1", "TB"),
        StudentDto("b20008", "ãƒ†ã‚¹ãƒˆ2", "UT"),
        StudentDto("c20198", "ãƒ†ã‚¹ãƒˆ3", "CT")
    )
val csvMapper = CsvMapper()
val schema = csvMapper.schemaFor(StudentDto::class.java).withHeader()
val studentText = csvMapper.writer(schema).writeValueAsString(studentList)
val csvBytes = studentText.toByteArray(Charsets.UTF_8)
```
ãã®å¾Œã€Httpãƒ˜ãƒƒãƒ€ãƒ¼ã®`Content-Disposition`ã«`attachment; filename=test.csv; filename*=UTF-8`ã‚’æŒ‡å®šã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚
```kotlin
return ResponseEntity.ok()
    .header(HttpHeaders.CONTENT_DISPOSITION, CONTENT_DISPOSITION_HEADER)
    .contentType(MEDIA_TYPE_TEXT_CSV)
    .body(csvBytes)
```
ã“ã®[Content-Disposition](https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Content-Disposition)ãŒé‡è¦ã§ã€ã“ã‚Œã¯ãªã‚“ãã‚„ã¨ã„ã†ã¨ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ã‹(inline)ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹(attachment)ã‚’æ±ºã‚ã‚‹ã‚‚ã®ã§ã€`"attachment; filename=test.csv; filename*=UTF-8"`ã®ã‚ˆã†ãªæŒ‡å®šã‚’ã—ã¦ã‚ã’ã‚‹ã¨ãã®ãƒ•ã‚¡ã‚¤ãƒ«åãƒ»æ–‡å­—ã‚³ãƒ¼ãƒ‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚

## å‹•ã‹ã—ã¦ã¿ã‚‹
ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’æŠ¼ä¸‹ã™ã‚‹ã¨...ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ããŸãƒ¼ğŸ¥³
![](https://storage.googleapis.com/zenn-user-upload/3e829d3bdc7f-20240419.png)

ä¸­èº«ã‚‚å•é¡Œãªã—ï¼
![](https://storage.googleapis.com/zenn-user-upload/ca073fb2cff5-20240419.png)

# ãŠã‚ã‚Šã«
ã“ã“ã¾ã§èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼
è‰¯ã‘ã‚Œã°ç•ªå¤–ç·¨ã‚‚è¦‹ã¦ã„ã£ã¦ãã ã•ã„ï¼

# ç•ªå¤–ç·¨
ãŠæ°—ã¥ãã®æ–¹ã‚‚ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ãŒã€ã“ã®å®Ÿè£…ã«ã¯å•é¡Œç‚¹ãŒã‚ã‚‹ã‚“ã§ã™...
ãã‚Œã¯ä½•ã‹ã¨ã„ã†ã¨...
Excelã§é–‹ãã¨æ–‡å­—åŒ–ã‘ã—ã¾ã™...
![](https://storage.googleapis.com/zenn-user-upload/89ee39cc69f8-20240419.png)

## ãªãœæ–‡å­—åŒ–ã‘ã™ã‚‹ã®ã‹
BOMãŒã¤ã„ã¦ã„ãªã„ã‹ã‚‰ã§ã™ï¼

ãªã‚‹ã»ã©ï¼ or ãã†ã ã‚ˆã­ãƒ¼ã€‚ã¨æ€ã£ãŸæ–¹ã¯BOMã‚’ã¤ã‘ã¦ã‚ã’ã¦ãã ã•ã„ã€‚
ã‚ã‹ã‚‰ã‚“... or BOMã£ã¦ãªã‚“ã‚„ã­ã‚“çŠ¶æ…‹ã®äººã¯ä»¥é™ã§è§£èª¬ã—ã¦ã„ãã¾ã™ï¼

## ãã‚‚ãã‚‚BOMã¨ã¯ï¼Ÿ
BOMï¼ˆByte Order Markï¼‰ã¯ã€ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚„æ–‡å­—ã‚³ãƒ¼ãƒ‰ãŒUTF-8ã‚„UTF-16ãªã©ã®Unicodeå½¢å¼ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å ´åˆã«ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã«è¿½åŠ ã•ã‚Œã‚‹ç‰¹æ®Šãªãƒã‚¤ãƒˆåˆ—ã§ã™ã€‚

Excelãªã©ã¯BOMã‚’è¦‹ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¬¦å·åŒ–å½¢å¼ã‚’åˆ¤åˆ¥ã™ã‚‹ã®ã§ã€BOMãŒã¤ã„ã¦ãªã„ã¨æ­£ã—ãåˆ¤åˆ¥ã§ããšã«æ–‡å­—åŒ–ã‘ã—ã¦ã—ã¾ã„ã¾ã™ã€‚

## å®Ÿè£…ä¿®æ­£
ä»¥ä¸‹ã®ã‚ˆã†ã«ã€ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã®å‰ã«æ–‡å­—ã‚³ãƒ¼ãƒ‰(ä»Šå›ã¯UTF-8)ã®ãƒã‚¤ãƒˆåˆ—ã‚’ã¤ã‘ã¦ã‚ã’ã¾ã™ã€‚(`val csvBytes = UTF8_BOM + studentText.toByteArray(Charsets.UTF_8)`ã®éƒ¨åˆ†)
```kotlin:FileDownLoadController
package com.example.demo.controller

import com.example.demo.dto.StudentDto
import com.fasterxml.jackson.dataformat.csv.CsvMapper
import jakarta.servlet.http.HttpServletResponse
import org.springframework.http.HttpHeaders
import org.springframework.http.MediaType
import org.springframework.http.ResponseEntity
import org.springframework.stereotype.Controller
import org.springframework.web.bind.annotation.GetMapping
import org.springframework.web.bind.annotation.RequestMapping

@Controller
@RequestMapping("/download")
class FileDownLoadController() {
    companion object {
        private val MEDIA_TYPE_TEXT_CSV = MediaType("text", "csv")
        private val UTF8_BOM = byteArrayOf(0xEF.toByte(), 0xBB.toByte(), 0xBF.toByte())
        private const val CONTENT_DISPOSITION_HEADER = "attachment; filename=test.csv; filename*=UTF-8"
    }

    @GetMapping
    fun index(): String {
        return "/index"
    }

    @GetMapping("/csv")
    fun downloadCsv(response: HttpServletResponse): ResponseEntity<ByteArray> {
        // ç”Ÿå¾’ã®ä»®ãƒ‡ãƒ¼ã‚¿
        val studentList =
            listOf(
                StudentDto("a20019", "ãƒ†ã‚¹ãƒˆ1", "TB"),
                StudentDto("b20008", "ãƒ†ã‚¹ãƒˆ2", "UT"),
                StudentDto("c20198", "ãƒ†ã‚¹ãƒˆ3", "CT")
            )
        val csvMapper = CsvMapper()
        val schema = csvMapper.schemaFor(StudentDto::class.java).withHeader()
        val studentText = csvMapper.writer(schema).writeValueAsString(studentList)
        val csvBytes = UTF8_BOM + studentText.toByteArray(Charsets.UTF_8)

        return ResponseEntity.ok()
            .header(HttpHeaders.CONTENT_DISPOSITION, CONTENT_DISPOSITION_HEADER)
            .contentType(MEDIA_TYPE_TEXT_CSV)
            .body(csvBytes)
    }
}
```

ã™ã‚‹ã¨.............æ–‡å­—åŒ–ã‘ã—ã¦ãªã„ï¼ï¼ï¼ï¼ï¼

![](https://storage.googleapis.com/zenn-user-upload/8cb6df8e296d-20240419.png)

## ãŠã‚ã‚Š2
ã“ã“ã¾ã§èª­ã‚“ã§ã„ãŸã ã„ãŸæ–¹ã€ã»ã‚“ã£ã£ã£ã£ã£ã¨ã†ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼
ä½•ã‹é–“é•ã£ã¦ã‚‹éƒ¨åˆ†ãŒã‚ã‚Œã°å„ªã—ãæ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚
